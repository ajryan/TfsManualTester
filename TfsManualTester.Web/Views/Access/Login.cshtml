@{
    ViewBag.Title = "Login";
}

@section scripts
{
    <script src="//js.live.net/v5.0/wl.js"></script>
    <script>
        $(document).ready(function () {

            var $loginError = $('#loginError');
            var $submitButton = $('#submit');
            
            $('#submit').live(
                'click',
                function(event) {
                    event.preventDefault();

                    var formData = $('#loginForm').serialize();
                    console && console.log('formData', formData);
                    
                    $.ajax({
                        url: '@Url.Action("TfsLogin")',
                        data: formData,
                        type: 'POST',
                        success: function (data) {
                            console && console.log('data', data);
                            if (data.Success === false) {
                                showLoginError(data.ErrorMessage);
                            }
                        },
                        error: function (xhr, status, error) {
                            console && console.log('status', status);
                            console && console.log('error', error);

                            showLoginError(status + ': ' + error);
                        }
                    });
                }
            );

            function showLoginError(message) {
                $loginError.text(message);
                $loginError.fadeTo(200, 1);
            }
            
            $loginError
                .hide()
                .ajaxStart(function () {
                    $submitButton.attr('disabled', 'disabled');
                    $loginError.fadeTo(200, 0);
                })
                .ajaxStop(function () {
                    $submitButton.removeAttr('disabled');
                });
            

            WL.Event.subscribe("auth.login", onLogin);
            WL.init({
                client_id: "@ViewBag.LiveIdAppId",
                redirect_uri: "@ViewBag.LiveIdRedirect",
                scope: "wl.signin",
                response_type: "token"
            });
            WL.ui({
                name: "signin",
                element: "signin"
            });
            function onLogin(session) {
                if (!session.error) {
                    WL.api({
                        path: "me",
                        method: "GET"
                    }).then(
                        function (response) {
                            showLoginError("Hello, " + response.first_name + " " + response.last_name + "!");
                        },
                        function (responseFailed) {
                            showLoginError("Error calling API: " + responseFailed.error.message);
                        }
                    );
                }
                else {
                    showLoginError("Error signing in: " + session.error_description);
                }
            }
        });
    </script>
}

<h2>LiveId Login</h2>
<div id="signin"></div>

@*<iframe 
    id="WebAuthControl" 
    name="WebAuthControl"
    src="https://login.live.com/controls/WebAuth.htm?appid=@ViewBag.LiveIdAppId&style=font-size%3A+10pt%3B+font-family%
        3A+verdana%3B+background%3A+white%3B"
    width="80px"
    height="20px"
    marginwidth="0"
    marginheight="0"
    align="middle"
    frameborder="0"
    scrolling="no"></iframe>*@

<h2>Tfs Login</h2>

<form id="loginForm">
    <label for="tfsUrl">Tfs Url:</label><input id="tfsUrl" name="tfsUrl" type="text" /><br />
    <label for="domain">Domain:</label><input id="domain" name="domain" type="text" /><br />
    <label for="userName">Username:</label><input id="userName" name="userName" type="text" /><br />
    <label for="password">Password:</label><input id="password" name="password" type="password" /><br />
    <button id="submit" type="submit">Login</button>
</form>

<div id="loginError" style="display: none">
</div>
